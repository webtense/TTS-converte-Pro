<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Conversor TTS</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
  <div class="card">
    <h1>Conversor TTS</h1>
    <form id="convert-form" enctype="multipart/form-data">
      <label>Archivo:
        <input type="file" name="archivo" id="archivo" required>
      </label>
      <label>Nombre base de salida:
        <input type="text" name="nombre" id="nombre" placeholder="MiAudiolibro">
      </label>
      <label>Idioma:
        <select name="idioma">
          <option value="castellano">Castellano</option>
          <option value="catalan">Catalán</option>
        </select>
      </label>
      <label>Género:
        <select name="genero">
          <option value="femenina">Femenina</option>
          <option value="masculina">Masculina</option>
        </select>
      </label>
      <label>Velocidad:
        <select name="velocidad">
          <option value="lenta">Lenta</option>
          <option value="normal" selected>Normal</option>
          <option value="rapida">Rápida</option>
        </select>
      </label>
      <label>Pitch:
        <input type="range" name="pitch" id="pitch" min="-20" max="20" value="0">
        <span id="pitch-val">0</span>
      </label>
      <label>Líneas por bloque:
        <input type="number" name="lineas" value="200" min="1">
      </label>
      <label>Pausa entre bloques (s):
        <input type="number" step="0.1" name="pausa" value="1">
      </label>
      <label>Carpeta de salida:</label>
      <div class="folder-picker">
        <input type="text" id="carpeta" name="carpeta" placeholder="salida" readonly>
        <button type="button" id="carpetaBtn">Elegir</button>
        <input type="file" id="carpetaInput" webkitdirectory directory style="display:none">
      </div>
      <button type="submit" class="btn">Convertir</button>
    </form>
    <div id="progress-container" class="hidden">
      <div id="progress-bar"></div>
    </div>
  </div>
  <script>
  const form = document.getElementById('convert-form');
  const fileInput = document.getElementById('archivo');
  const nombreInput = document.getElementById('nombre');
  const pitch = document.getElementById('pitch');
  const pitchVal = document.getElementById('pitch-val');
  pitch.addEventListener('input', ()=>{ pitchVal.textContent = pitch.value; });

  fileInput.addEventListener('change', ()=>{
    const name = fileInput.files[0]?.name.replace(/\.[^/.]+$/, '') || '';
    nombreInput.value = name;
  });

  const carpetaBtn = document.getElementById('carpetaBtn');
  const carpetaInput = document.getElementById('carpetaInput');
  const carpetaText = document.getElementById('carpeta');
  carpetaBtn.addEventListener('click', ()=>carpetaInput.click());
  carpetaInput.addEventListener('change', (e)=>{
    if(carpetaInput.files.length>0){
      const path = carpetaInput.files[0].webkitRelativePath.split('/')[0];
      carpetaText.value = path;
    }
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const data = new FormData(form);
    const file = form.querySelector('input[type=file]').files[0];
    const est = Math.max(5, file.size / 50000); // segundos estimados
    const bar = document.getElementById('progress-bar');
    const container = document.getElementById('progress-container');
    container.classList.remove('hidden');
    let start = Date.now();
    const duration = est * 1000;
    function animate(){
      const now = Date.now();
      const pct = Math.min(100, ((now-start)/duration)*100);
      bar.style.width = pct + '%';
      if(pct < 100){ requestAnimationFrame(animate); }
    }
    animate();
    const resp = await fetch('/convert', {method:'POST', body:data});
    const html = await resp.text();
    document.open();
    document.write(html);
    document.close();
  });
  </script>
</body>
</html>
